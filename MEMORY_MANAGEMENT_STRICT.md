# 厳格なメモリ管理ガイドライン

## ⚠️ CRITICAL: Node.js Heap Out of Memory Error 再発防止

このドキュメントは、2025-10-22に発生したheap out of memoryエラーを受けて作成されました。

### 発生したエラー
```
FATAL ERROR: Reached heap limit Allocation failed - JavaScript heap out of memory
- メモリ使用量: 約2GB
- 発生箇所: JSON.stringify処理中
- 作業内容: フォーマット修正作業（20エントリ処理時）
```

## 適用範囲

このガイドラインは以下のすべての作業に適用されます：
- ✅ **翻訳作業** (translation/.translation_progress.json)
- ✅ **フォーマット修正作業** (translation/.format_fix_progress.json) ← **現在のタスク**
- ✅ その他の大規模ファイル処理

## 厳格なルール（MUST FOLLOW）

### 1. チャンクサイズの削減

**旧設定（メモリ不足発生）:**
- バッチサイズ: 100-200行
- コミット頻度: 500エントリ

**新設定（必須 - 翻訳・フォーマット修正共通）:**
- **通常処理**: 50行/チャンク
- **最大**: 100行/チャンク (メモリ < 2GB時のみ)
- **メモリ警告後**: 30-50行/チャンク
- **NEVER exceed**: 100行/チャンク

### 2. コミット頻度の大幅向上

**旧設定:**
- 500エントリごとにコミット

**新設定（必須 - 翻訳・フォーマット修正共通）:**
- **100-200エントリごとにコミット**
- セクション完了時は即座にコミット
- コミット後は必ず進捗ファイルを更新
- 翻訳: `translation/.translation_progress.json`
- フォーマット修正: `translation/.format_fix_progress.json`

### 3. セッションメモリ監視の強化

**監視コマンド:**
```bash
# Claude Codeプロセスのメモリ使用量を確認
ps aux | grep claude | awk '{print $6/1024 " MB"}'
```

**監視頻度:**
- 50-100エントリ処理ごと（約500-1000行）
- 各コミット前

**メモリ閾値:**
- **警告レベル**: 4GB → チャンクサイズを50%削減
- **危険レベル**: 6GB → 即座にコミットしてセッション再起動
- **旧設定の6-7GB閾値は遅すぎる**

### 4. セッション再起動プロトコル

**再起動タイミング:**
1. メモリが6GBに到達した時（自動）
2. 2000-3000エントリ処理後（予防的）
3. エラーまたは警告発生時（即座）

**再起動手順:**
```bash
# 1. 現在の作業をコミット
git add .
git commit -m "作業中断: セッション再起動前の保存"

# 2. 進捗ファイルを確認
cat translation/.format_fix_progress.json

# 3. Claude Code を終了
exit

# 4. 新しいセッションを開始
claude

# 5. 作業を再開
"translation/.format_fix_progress.json を読み込んで、CLAUDE.mdのルールに従って翻訳作業を継続してください。"
```

### 5. 大きなファイル操作の禁止

**禁止事項:**
- ❌ ファイル全体を一度にReadする（530K行のファイル）
- ❌ 大きな配列を一度にメモリに展開
- ❌ 複数のチャンクを並列で処理
- ❌ git diffで大きな変更を一度に表示（`head`を使用）

**許可事項:**
- ✅ offset/limitパラメータを使ったチャンク読み込み
- ✅ 逐次的な処理（1チャンクずつ）
- ✅ 頻繁な変数クリア
- ✅ `git diff | head -N` で制限付き表示

### 6. 自動化スクリプトの改善

**auto-translate.sh の改善点:**
```bash
# メモリ監視を追加
check_memory() {
    local mem_mb=$(ps aux | grep "claude$" | grep -v grep | awk '{print $6/1024}')
    if (( $(echo "$mem_mb > 6000" | bc -l) )); then
        echo "メモリ警告: ${mem_mb}MB - セッション再起動"
        return 1
    fi
    return 0
}

# より頻繁なメモリチェック
while true; do
    # 50エントリごとにメモリチェック
    check_memory || break
    # 翻訳処理
done
```

### 7. 進捗ファイルのバックアップ

**毎回のコミット後:**
```bash
# 進捗ファイルのバックアップ
cp translation/.format_fix_progress.json \
   translation/.format_fix_progress.backup.json
```

### 8. エラー発生時の対応フロー

1. **即座に停止**: これ以上の処理を行わない
2. **現在の変更を確認**: `git diff`（制限付き）
3. **変更をコミット**: 作業を保護
4. **進捗ファイルを更新**: 次回の再開ポイントを記録
5. **セッション再起動**: 新しいセッションで継続
6. **チャンクサイズを削減**: 50% → 30-50行/チャンク

### 9. 自動化での処理速度調整

**メモリ使用量に応じた動的調整:**
- < 2GB: 100行/チャンク、200エントリ/コミット
- 2-4GB: 50行/チャンク、100エントリ/コミット
- 4-6GB: 30行/チャンク、50エントリ/コミット、次のコミット後に再起動
- > 6GB: 即座にコミット＆再起動

### 10. 翻訳品質を維持しながらメモリ削減

**メモリ効率的な翻訳フロー:**
```
1. Read (50-100行, offset/limit使用)
2. 翻訳（メモリ内で処理、中間変数を最小化）
3. Edit（即座に書き込み）
4. 変数クリア（明示的に null 代入）
5. 次のチャンクへ
6. 100エントリごとにコミット
```

## 実装チェックリスト

- [ ] チャンクサイズを50-100行に削減
- [ ] コミット頻度を100-200エントリに変更
- [ ] メモリ監視を50-100エントリごとに実施
- [ ] メモリ閾値を4GB/6GBに設定
- [ ] 自動化スクリプトにメモリ監視を追加
- [ ] 進捗ファイルの自動バックアップを実装
- [ ] エラー対応フローをドキュメント化
- [ ] セッション再起動手順を自動化

## 参考: CLAUDE.md の既存ガイドライン

このドキュメントは CLAUDE.md の「Memory Management」セクションを補完し、より厳格な基準を設定しています。

**CLAUDE.md との違い:**
- CLAUDE.md: 100-200行/チャンク → **新基準: 50-100行/チャンク**
- CLAUDE.md: 500エントリ/コミット → **新基準: 100-200エントリ/コミット**
- CLAUDE.md: 6-7GB再起動 → **新基準: 6GB再起動、4GB警告**
