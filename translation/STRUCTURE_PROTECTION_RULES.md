# Structure Protection Rules (構造保護ルール)

## 概要

このドキュメントは、Unity StringTableファイルの構造を保護するための厳格なルールを定義します。
これらのルールに違反すると、ファイルがゲームにインポート不可能になります。

## 絶対に変更してはいけない記号とパターン

### 1. Unity構造マーカー（最優先）

**`""` (半角ダブルクォーテーション2つ):**
- Unity StringTableの文字列開始/終了マーカー
- **テキストの前後に半角 `"` が2つずつ必要**（合計4つの `"` 文字）
- **絶対に `「」` `『』` `""` （全角）などに変換してはいけない**
- **絶対に `\"` のようなエスケープ処理をしてはいけない**

**正しい形式の理解:**
```
string data = ""Japanese text here""
              ↑↑              ↑↑
              12              34
```
- 位置1: 外側の文字列デリミタ（半角 `"`）
- 位置2: 内側のテキスト境界マーカー（半角 `"`）
- 位置3: 内側のテキスト境界マーカー（半角 `"`）
- 位置4: 外側の文字列デリミタ（半角 `"`）

**例:**
```
✅ 正常: string data = ""こんにちは、カウボーイ。""
         （半角 " が4つ: 2つ前、2つ後）

❌ 破損: string data = "「こんにちは、カウボーイ。」"
         （日本語括弧を使用）

❌ 破損: string data = ""こんにちは、カウボーイ。""
         （全角ダブルクォーテーションを使用）

❌ 破損: string data = "\"こんにちは、カウボーイ。\""
         （エスケープ処理を使用 - 絶対禁止！）

❌ 破損: string data = "'こんにちは、カウボーイ。'"
         （シングルクォーテーションを使用）
```

**⚠️ クォーテーションのエスケープ処理は絶対禁止:**
Unity StringTable形式ではバックスラッシュ（`\`）によるクォーテーションのエスケープは**使用禁止**です。
`\"` のような記述は構造を破壊します。必ず `""` （半角ダブルクォート2つ）を使用してください。

**⚠️ 注意: テキスト内制御文字は保持すること:**
ただし、テキスト内の改行（`\n`）、キャリッジリターン（`\r`）、タブ（`\t`）などの制御文字は**正当なエスケープシーケンス**であり、保持する必要があります。
```
✅ 正常: string data = ""一行目\n二行目""
❌ 破損: string data = ""一行目
二行目""  （改行が壊れている）
```

### 2. 特殊フォーマットマーカー

**`[ ]` (角括弧):**
- ラジオ周波数、スクリプトノード、特殊指示などに使用
- 括弧内の内容も含めて変更禁止（翻訳対象外）
- 例: `[Switch to 27.065 Megahertz]`, `[Script Node 14]`

**例:**
```
✅ 正常: string data = "[Switch to 27.065 Megahertz] ""Message here"""
❌ 破損: string data = "【27.065メガヘルツに切り替え】 "Message here""
```

**`' '` (シングルクォーテーション):**
- 引用や固有名詞の強調に使用
- **絶対に `'` `'` や `「」` に変換してはいけない**
- 例: `'The Night Has a Thousand Eyes'`

**例:**
```
✅ 正常: ""You know that old song, 'The Night Has a Thousand Eyes?'""
❌ 破損: ""You know that old song, '夜には千の目がある?'""
```

### 3. アクションマークアップ（ゲームエンジン処理用）

**`::action::` 形式:**
- キャラクターの動作・感情を示すゲームエンジンマーカー
- **絶対に翻訳してはいけない**
- **`::`（ダブルコロン）の形式を変更してはいけない**

**翻訳禁止のアクションマークアップ例:**
```
::sings::      歌う
::laughs::     笑う
::coughs::     咳をする
::whispers::   ささやく
::shouts::     叫ぶ
::cries::      泣く
::sighs::      ため息をつく
::groans::     うめく
::screams::    絶叫する
::mutters::    つぶやく
```

**例:**
```
✅ 正常: string data = ""::laughs:: That's hilarious!""
          → ""::laughs:: それは面白い！""
❌ 破損: string data = ""【笑い】 それは面白い！""
❌ 破損: string data = ""：：笑う：： それは面白い！""
```

### 4. HTML/XMLタグ

**`< >` (山括弧):**
- HTMLタグ、変数プレースホルダーなどに使用
- タグ名と構造を変更してはいけない
- 例: `<color=red>`, `<b>`, `</b>`, `{variable_name}`

**例:**
```
✅ 正常: string data = ""<color=red>Warning!</color> Message here""
❌ 破損: string data = ""＜color=red＞警告！＜/color＞ Message here""
```

### 5. 技術用語（翻訳禁止）

**`Script Node` + 数字:**
- ゲームエンジン内部の識別子
- **絶対に翻訳してはいけない**

**例:**
```
✅ 正常: string data = ""Script Node 14""
❌ 破損: string data = ""スクリプトノード 14""
```

## 正規表現パターン（検証用）

### 破損パターンの検出

```bash
# クォーテーションのエスケープ処理の誤使用（最優先で検出）
# 注意: これは \" を検出するが、\n（改行）や \r（キャリッジリターン）は検出しない
grep 'string data = "\\"' file.txt

# 壊れた構造マーカー（日本語括弧）の検出
grep 'string data = "「' file.txt
grep 'string data = "『' file.txt

# 全角ダブルクォーテーションの検出
grep 'string data = ""' file.txt

# 壊れたアクションマークアップの検出
grep 'string data = ""【.*】' file.txt
grep 'string data = ""：：.*：：' file.txt

# 壊れた角括弧の検出
grep 'string data = ""【.*】' file.txt

# 翻訳されたScript Nodeの検出
grep 'string data = ""スクリプトノード' file.txt
```

### 正常パターンの確認

```bash
# 正常な構造マーカー（日本語テキスト含む）
grep 'string data = "".*[ぁ-ん].*""' file.txt

# 正常なアクションマークアップ
grep 'string data = ""::[a-z]*::' file.txt

# 正常な角括弧（英語のまま）
grep 'string data = ""\[.*\]' file.txt
```

## チェックリスト（コミット前に必ず確認）

- [ ] **クォーテーションのエスケープが使用されていない**（`\"` が存在しない）
- [ ] **テキスト内制御文字は保持されている**（`\n` `\r` `\t` など）
- [ ] `""` マーカーが全て保持されている（半角ダブルクォート2つ）
- [ ] 日本語括弧に変換されていない（`「」` `『』` が構造マーカーに使われていない）
- [ ] 全角クォーテーションが使われていない（`""` `''`）
- [ ] `[ ]` 内の技術用語が英語のまま保持されている
- [ ] `::action::` 形式が全て英語のまま保持されている
- [ ] `< >` タグが壊れていない
- [ ] `Script Node` が翻訳されていない
- [ ] ファイルの行数が元ファイルと一致している
- [ ] 中国語（簡体字）が混入していない

## エラー例と修正方法

### エラー1: クォーテーションのエスケープ処理の誤使用（最も危険）

```
❌ 誤り:
   string data = "\"よう、カウボーイたち。デッド・レッドだ。\""

✅ 修正:
   string data = ""よう、カウボーイたち。デッド・レッドだ。""
```

**説明:** バックスラッシュ（`\`）によるクォーテーションのエスケープは不要。Unity StringTable形式では `""` （半角ダブルクォート2つ）を直接使用する。

**注意:** テキスト内の改行（`\n`）やその他の制御文字は正当なエスケープシーケンスであり、保持すること。

### エラー2: 構造マーカーの日本語括弧への変換

```
❌ 誤り:
   string data = "「よう、カウボーイたち。デッド・レッドだ。」"

✅ 修正:
   string data = ""よう、カウボーイたち。デッド・レッドだ。""
```

**説明:** 日本語括弧 `「」` `『』` は構造マーカーとして使用できない。必ず半角 `""` を使用する。

### エラー3: アクションマークアップの翻訳

```
❌ 誤り:
   string data = ""【笑い】 それは面白い！""

✅ 修正:
   string data = ""::laughs:: それは面白い！""
```

### エラー4: 角括弧内の翻訳

```
❌ 誤り:
   string data = "【27.065メガヘルツに切り替え】 "ニュースは聞いたと思うが""

✅ 修正:
   string data = "[Switch to 27.065 Megahertz] "ニュースは聞いたと思うが""
```

### エラー5: 入れ子引用符の処理

```
❌ 誤り:
   string data = ""「『夜には千の目がある』って古い歌を知ってるか？」""

✅ 修正:
   string data = ""'夜には千の目がある'って古い歌を知ってるか？""
```

## 自動化スクリプトへの注意

**スクリプトによる一括変換は禁止:**
- 過去に何度も修復不可能な構造破壊が発生
- 必ず50-100行のチャンク処理で手動確認
- 正規表現による一括置換は危険

**安全な処理方法:**
1. backup_brokenから日本語テキストを抽出
2. 構造マーカーは英語ファイルから保持
3. テキスト部分のみを慎重に置換
4. 各チャンクごとに検証
5. 100エントリごとにコミット

## 参考資料

- Unity StringTable公式ドキュメント
- `nouns_glossary.json` の `do_not_translate` セクション
- `translation/FORMAT_FIX_CLAUDE.md`
